services:
  app:
    container_name: openskidata-processor
    build:
      context: .
      target: development
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - dist:/app/dist
      - postgres_data:/var/lib/postgresql/data
      - shared_data:/data/shared:rw
      - dem_data:/data/dem:rw # rw needed for prepare-dem.sh to write output
      - ~/Downloads:/downloads:ro # Host downloads folder (read-only)
    working_dir: /app
    stdin_open: true
    tty: true
    ports:
      # PostgreSQL inside the container listens on 5432.
      # Host port 5433 is used to avoid clashing with a local Postgres on 5432.
      # If you want to restrict access to localhost only, change to: "127.0.0.1:5433:5432"
      - "5433:5432"
    environment:
      - POSTGRES_USER=dev
      - POSTGRES_PASSWORD=dev
      # - BBOX=[10.74827, 46.81017, 11.08733, 47.00510] # Ã–tztal large
      - BBOX=[6.47996, 45.21026, 6.67171, 45.45132] # Savoie, France
      #- BBOX=[11.85573,47.223133,12.119387,47.42013 ] # Innsbruck, Austria
      - OUTPUT_TO_FILES=1
      - OUTPUT_TO_POSTGIS=1

      # ===== Elevation Enrichment =====
      # Set to 0 to disable elevation enrichment (2D geometries, faster processing)
      - CONFLATE_ELEVATION=1
      # AWS Terrain Tiles (~30m) is used by default - no config needed.
      # Other sources automatically fall back to AWS for coordinates they can't cover.
      - INTERPOLATE_HEIGHT_INFORMATION=true # default: true
      - ELEVATION_SERVER_ZOOM=15 # default: 15

      # Local DEM: High-resolution local files, AWS fills gaps (see docs/LOCAL_DEM.md) - FRANCE: https://geoservices.ign.fr/rgealti
      # Setup: docker volume create dem_data && add GeoTIFF files
      - ELEVATION_SERVER_TYPE=local-dem
      - LOCAL_DEM_DIRECTORY=/data/dem

      # WCS: Web Coverage Service (example: Tyrol 50cm DEM)
      #- ELEVATION_SERVER_TYPE=wcs
      #- ELEVATION_SERVER_URL=https://gis.tirol.gv.at/arcgis/services/Service_Public/terrain/MapServer/WCSServer
      #- ELEVATION_WCS_COVERAGE_ID=Gelaendemodell_50cm_M28

      # Disable elevation entirely (not recommended)
      #- ELEVATION_SERVER_TYPE=none
      # ===== End Elevation =====

      - GENERATE_MBTILES=1 # results in mbtiles files for runs, lifts and ski areas, as well as a combined mbtiles file
      - GENERATE_3D_TILES=1 # Generate 3D Tiles tilesets (requires OUTPUT_TO_POSTGIS=1)
      # Set to false to only start PostgreSQL without running the processing pipeline
      - COMPILE_NEW=true
      # Set to 1 to enable highway (road/walkway) compilation
      - COMPILE_HIGHWAY=1
      # Set to 1 to keep polygon ski areas even when >50% of runs/lifts are in site=piste relations
      - KEEP_LANDUSE_WITH_SITE_OVERLAP=1

volumes:
  node_modules:
  dist:
  postgres_data:
  shared_data:
    external: true
  dem_data:
    external: true # Create with: docker volume create dem_data
